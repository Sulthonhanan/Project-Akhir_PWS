<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>ElectroStore | Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="dashboard-layout">

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="brand-logo">
            <i class="ri-store-2-line"></i> ElectroStore
        </div>

        <div class="nav-item active" id="nav-overview" onclick="switchTab('overview')">
            <i class="ri-dashboard-line"></i> Dashboard
        </div>
        <div class="nav-item" id="nav-users" onclick="switchTab('users')">
            <i class="ri-user-3-line"></i> Users
        </div>
        <div class="nav-item" id="nav-keys" onclick="switchTab('keys')">
            <i class="ri-key-2-line"></i> API Keys
        </div>
        <div class="nav-item" id="nav-products" onclick="switchTab('products')">
            <i class="ri-shopping-bag-3-line"></i> Products
        </div>

        <button class="btn btn-danger" onclick="logout()" style="margin-top:auto;">
            <i class="ri-logout-box-line"></i> Logout
        </button>
    </aside>

    <!-- MAIN -->
    <main class="main-content">

        <!-- TOP HEADER -->
        <div class="header-dash">
            <div>
                <h2>ElectroStore Admin Control</h2>
                <p style="color:var(--text-muted)">Manage users, API keys, and product catalog</p>
            </div>
            <div class="badge badge-active">System Online</div>
        </div>

        <!-- OVERVIEW -->
        <section id="section-overview" class="section-view active">
            <div class="stats-grid">
                <div class="glass-card">
                    <div>Total Users</div>
                    <div class="stat-num" id="statUsers">0</div>
                </div>
                <div class="glass-card">
                    <div>Active API Keys</div>
                    <div class="stat-num" id="statKeys">0</div>
                </div>
                <div class="glass-card">
                    <div>Products</div>
                    <div class="stat-num" id="statProducts">0</div>
                </div>
            </div>
        </section>

        <!-- USERS -->
        <section id="section-users" class="section-view">
            <h3>User Management</h3>
            <div class="glass-card">
                <table>
                    <thead>
                        <tr><th>ID</th><th>Username</th><th>Joined</th><th>Action</th></tr>
                    </thead>
                    <tbody id="userTableBody"></tbody>
                </table>
            </div>
        </section>

        <!-- KEYS -->
        <section id="section-keys" class="section-view">
            <h3>API Key Monitor</h3>
            <div class="glass-card">
                <table>
                    <thead>
                        <tr><th>Owner</th><th>Label</th><th>Key</th><th>Action</th></tr>
                    </thead>
                    <tbody id="keyTableBody"></tbody>
                </table>
            </div>
        </section>

        <!-- PRODUCTS -->
        <section id="section-products" class="section-view">
            <h3>Product Catalog</h3>

            <!-- FORM -->
            <div class="glass-card" style="margin-bottom:20px">
                <div style="display:grid;grid-template-columns:2fr 1fr 1fr auto;gap:10px">
                    <input id="prodName" placeholder="Product Name">
                    <input id="prodPrice" type="number" placeholder="Price (Rp)">
                    <input id="prodStock" type="number" placeholder="Stock">
                    <button id="btnSaveProduct" class="btn btn-primary" onclick="handleFormSubmit()">
                        <i class="ri-add-line"></i> Save
                    </button>
                </div>

                <div id="cancelEditBox" style="display:none;text-align:right;margin-top:10px">
                    <span style="font-size:12px;color:#ff9f43">Editing mode</span>
                    <button class="btn btn-ghost" onclick="cancelEdit()">Cancel</button>
                </div>
            </div>

            <!-- TABLE -->
            <div class="glass-card">
                <table>
                    <thead>
                        <tr><th>ID</th><th>Product</th><th>Price</th><th>Stock</th><th>Action</th></tr>
                    </thead>
                    <tbody id="productTableBody"></tbody>
                </table>
            </div>
        </section>

    </main>
</div>

<script>
let allProducts = [];
let editingId = null;

window.onload = async () => {
    const auth = await fetch('/auth/me').then(r => r.json());
    if (!auth.loggedIn || auth.user.role !== 'admin') location.href='/index.html';
    loadStats();
};

function switchTab(tab){
    document.querySelectorAll('.section-view').forEach(s=>s.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
    document.getElementById('section-'+tab).classList.add('active');
    document.getElementById('nav-'+tab).classList.add('active');
    if(tab==='overview') loadStats();
    if(tab==='users') loadUsers();
    if(tab==='keys') loadKeys();
    if(tab==='products') loadProducts();
}

async function loadStats(){
    const d=await fetch('/api/admin/stats').then(r=>r.json());
    statUsers.innerText=d.users;
    statKeys.innerText=d.keys;
    statProducts.innerText=d.products;
}

async function loadUsers(){
    const d=await fetch('/api/admin/users').then(r=>r.json());
    userTableBody.innerHTML='';
    d.forEach(u=>{
        userTableBody.innerHTML+=`
        <tr>
            <td>#${u.id}</td>
            <td>${u.username}</td>
            <td>${new Date(u.created_at).toLocaleDateString()}</td>
            <td><button class="btn btn-danger" onclick="banUser(${u.id})">Ban</button></td>
        </tr>`;
    });
}

async function loadKeys(){
    const d=await fetch('/api/admin/all-keys').then(r=>r.json());
    keyTableBody.innerHTML='';
    d.forEach(k=>{
        keyTableBody.innerHTML+=`
        <tr>
            <td>${k.username}</td>
            <td>${k.key_label}</td>
            <td><code>${k.api_key.slice(0,8)}...</code></td>
            <td><button class="btn btn-danger" onclick="revokeKey(${k.id})">Revoke</button></td>
        </tr>`;
    });
}

async function loadProducts(){
    allProducts=await fetch('/api/admin/products').then(r=>r.json());
    productTableBody.innerHTML='';
    allProducts.forEach(p=>{
        const harga=new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR'}).format(p.harga);
        productTableBody.innerHTML+=`
        <tr>
            <td>#${p.id}</td>
            <td>${p.nama_produk}</td>
            <td>${harga}</td>
            <td>${p.stok}</td>
            <td>
                <button class="btn btn-ghost" onclick="editProduct(${p.id})"><i class="ri-pencil-line"></i></button>
                <button class="btn btn-ghost" onclick="deleteProduct(${p.id})"><i class="ri-delete-bin-line"></i></button>
            </td>
        </tr>`;
    });
}

function editProduct(id){
    const p=allProducts.find(x=>x.id===id);
    prodName.value=p.nama_produk;
    prodPrice.value=p.harga;
    prodStock.value=p.stok;
    editingId=id;
    btnSaveProduct.innerHTML='<i class="ri-save-line"></i> Update';
    cancelEditBox.style.display='block';
}

function cancelEdit(){
    editingId=null;
    prodName.value=prodPrice.value=prodStock.value='';
    btnSaveProduct.innerHTML='<i class="ri-add-line"></i> Save';
    cancelEditBox.style.display='none';
}

async function handleFormSubmit(){
    const body={nama_produk:prodName.value,harga:prodPrice.value,stok:prodStock.value};
    if(!body.nama_produk) return alert('Nama produk wajib diisi');
    if(editingId){
        await fetch(`/api/admin/products/${editingId}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
        cancelEdit();
    }else{
        await fetch('/api/admin/products',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    }
    loadProducts(); loadStats();
}

async function deleteProduct(id){
    if(confirm('Hapus produk?')) await fetch(`/api/admin/products/${id}`,{method:'DELETE'});
    loadProducts(); loadStats();
}
async function banUser(id){ if(confirm('Ban user?')) await fetch(`/api/admin/users/${id}`,{method:'DELETE'}); loadUsers(); }
async function revokeKey(id){ if(confirm('Revoke key?')) await fetch(`/api/admin/revoke/${id}`,{method:'DELETE'}); loadKeys(); }

function logout(){ fetch('/auth/logout').then(()=>location.href='/index.html'); }
</script>

</body>
</html>
